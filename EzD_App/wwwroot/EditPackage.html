<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>EZ Delivery - Edit Packages</title>
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Custom styles for this template -->
    <link href="css/small-business.css" rel="stylesheet">
    <link href="css/MyStyle.css" rel="stylesheet" />
    <link href="css/sendPackageStyle.css" rel="stylesheet" />
    <link href="css/Loader.css" rel="stylesheet" />
    <script src="scripts/NavbarState.js"></script>
    <script src="scripts/Loading.js"></script>
</head>

<body onload="NavbarState(); ShowForm(); GetEmail()">
    <!-- Loader -->
    <div class="loader"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">EZ Delivery</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/Home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sendPackages.html">Send Package</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="myPackages.html">Packages</a>
                    </li>
                    <li class="nav-item" id="deliveries">
                        <a class="nav-link" href="myDeliveries.html">Deliveries</a>
                    </li>
                    <li class="nav-item">
                        <a id="profileName" class="nav-link" href="/Identity/Account/Manage">My Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Identity/Account/Logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div class="container card text-white bg-secondary my-5 py-4 text-center">
        <div class="card-body">
            <p id="headTitle" style="font-size:25px;" class="text-white m-0">Please Edit Your Package</p>
        </div>
    </div>

    <div style="text-align:center" class="container">
        <form id="PackageForm" class="form-horizontal" method="post" action="/Home">
            <fieldset>
                <div class="form-popup" id="myForm">
                    <div class="form-group row">
                        <label class="col-md-6 col-form-label" for="SenderNum">Recipient Phone Number </label>
                        <div class="col-md-6">
                            <input id="RecipientNum" name="RecipientNum" type="text" pattern="[0]([0-9]{9})"
                                   placeholder="Phone Number" class="form-control input-md" required="" title="Incorrect Name">
                        </div>
                    </div>
                </div>

                <!-- number input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="SenderNum">Sender's Phone Number </label>
                    <div class="col-md-6">
                        <input id="SenderNum" name="SenderNum" type="text" pattern="[0]([0-9]{9})" placeholder="Phone Number"
                               class="form-control input-md" required="" title="invalid number">

                    </div>
                </div>
                <!-- number input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="preferred_name">Weight </label>
                    <div class="col-md-6">
                        <input id="Weight" name="Weight" type="number" max="9999" min="1" step="0.1"
                               placeholder="Weight - [KG]" class="form-control input-md">
                    </div>
                </div>
                <!-- Date and time input -->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="date_of_birth">Shipping Date</label>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input id="ShippingDate" name="ShippingDate" class="form-control" type="date"
                                   placeholder="dd/mm/yyyy" onclick="minimumShippingDate()">
                        </div>
                    </div>
                </div>

                <!-- Date input -->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="date_of_birth">Deadline Date</label>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input id="Deadlinedate" name="Deadlinedate" class="form-control" type="date"
                                   placeholder="dd/mm/yyyy" onclick="minimumDeadlinedate()">
                        </div>
                    </div>
                </div>

                <!-- Text input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="RecipientName">Pick Up Address</label>
                    <div class="col-md-2">
                        <input id="cityPick" name="PickupAdress" type="text" pattern="[^'][A-Z a-z-]{1,20}" placeholder="City"
                               class="form-control input-md" required="">
                    </div>
                    <div class="col-md-2">
                        <input id="streetPick" name="PickupAdress" type="text" pattern="[^'][A-Z a-z-]{1,20}" placeholder="Street"
                               class="form-control input-md" required="">
                    </div>
                    <div class="col-md-2">
                        <input id="houseNumPick" name="PickupAdress" type="text" placeholder="House Number"
                               max="9999" min="0" pattern="^[1-9]\d*$" class="form-control input-md" required="">
                    </div>
                </div>

                <!-- Text input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="RecipientName">Drop Address</label>
                    <div class="col-md-2">
                        <input id="cityDrop" name="DropAddress" type="text" pattern="[^'][A-Z a-z-]{1,20}" placeholder="City"
                               class="form-control input-md" required="">
                    </div>
                    <div class="col-md-2">
                        <input id="streetDrop" name="DropAddress" type="text" pattern="[^'][A-Z a-z-]{1,20}" placeholder="Street"
                               class="form-control input-md" required="">
                    </div>
                    <div class="col-md-2">
                        <input id="houseNumDrop" name="DropAddress" type="text" placeholder="House Number"
                               max="9999" min="0" pattern="^[1-9]\d*$" class="form-control input-md" required="">
                    </div>
                </div>

                <!-- Text input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="RecipientName">Description</label>
                    <div class="col-md-6">
                        <input id="description" name="Description" type="text" pattern="[^'<>;]{1,100}"
                               placeholder="Description" class="form-control input-md" required="">
                    </div>
                </div>

                <!-- Number input-->
                <div class="form-group row">
                    <label class="col-md-6 col-form-label" for="RecipientName">Price</label>
                    <div class="col-md-6">
                        <input id="Price" name="Price" type="number" pattern="^-" placeholder="Price"
                               max="9999" min="1" class="form-control input-md" required="">
                    </div>
                </div>

                <!-- Button -->
                <div id="submitDiv" style="text-align:center" class="form-group row">
                    <div class="col-md-12">
                        <input type="button" name="Save changes" value="Save changes" onclick="SaveChanges()" />
                        <input type="button" name="Cancel" value="Cancel" onclick="BackToMyPackagesPage()" />
                    </div>
                </div>
            </fieldset>
        </form>
    </div>

    <!-- Footer -->
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white">
                Copyright &copy; Team TLORT &nbsp;
                <a class="footer_a" href="/Home/aboutUs">About Us</a> &nbsp;
                <a class="footer_a" href="/Home/contactUs">Contact Us</a>
            </p>
        </div>
    </footer>

    <script>
        function ShowForm() {
            try {
                let url_string = (window.location.href).toLowerCase();
                let url = new URL(url_string);
                var packageid = url.searchParams.get("package");
            }
            catch (err) {
                console.log(err);
            }

            $.ajax({
                dataType: "json",
                url: "/api/Package/GetPackage",
                contentType: "application/json",
                type: "POST",
                data: JSON.stringify(packageid),
                success: function (packageToEdit) {

                    document.getElementById("headTitle").innerHTML = "Please Edit Your Package";

                    document.getElementById("RecipientNum").value = packageToEdit.ContactPhone;
                    document.getElementById("SenderNum").value = packageToEdit.SenderPhone;
                    document.getElementById("Weight").value = packageToEdit.Weight;
                    document.getElementById("ShippingDate").value = packageToEdit.PickUpDate.slice(0, 10);
                    document.getElementById("Deadlinedate").value = packageToEdit.DeadLineDate.slice(0, 10);
                    document.getElementById("cityPick").value = packageToEdit.FromAddress.City;
                    document.getElementById("streetPick").value = packageToEdit.FromAddress.Street;
                    document.getElementById("houseNumPick").value = packageToEdit.FromAddress.HouseNum;
                    document.getElementById("cityDrop").value = packageToEdit.ToAddress.City;
                    document.getElementById("streetDrop").value = packageToEdit.ToAddress.Street;
                    document.getElementById("houseNumDrop").value = packageToEdit.ToAddress.HouseNum;
                    document.getElementById("description").value = packageToEdit.Description;
                    document.getElementById("Price").value = packageToEdit.Price;

                    document.getElementById("PackageForm").style.display = "block";
                },
                error:
                    function (err) {
                        console.log(err);
                    }
            });
        }

        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }

        $(function () {
            $(":file").change(function () {
                if (this.files && this.files[0]) {
                    let reader = new FileReader();

                    reader.onload = imageIsLoaded;
                    reader.readAsDataURL(this.files[0]);
                }
            });
        });

        function imageIsLoaded(e) {
            $('#myImg').attr('src', e.target.result);
            $('#yourImage').attr('src', e.target.result);
        }

        function minimumShippingDate() {
            let today = new Date();

            let dd = today.getDate();
            let mm = today.getMonth() + 1; //January is 0 so need to add 1 to make it 1!
            let yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd
            }

            if (mm < 10) {
                mm = '0' + mm
            }

            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("ShippingDate").setAttribute("min", today);
        }

        function minimumDeadlinedate() {
            let shippingDate = document.getElementById("ShippingDate").value;

            if (!shippingDate) {
                alert("Please fill shipping date first!");
                return;
            }

            document.getElementById("Deadlinedate").setAttribute("min", shippingDate);
        }

        function BackToMyPackagesPage() {
            window.location.assign("myPackages.html")
        }

        function SaveChanges() {
            try {
                let url_string = (window.location.href).toLowerCase();
                let url = new URL(url_string);
                var packageid = url.searchParams.get("package");
            }
            catch (err) {
                console.log(err);
            }

            let packageToEdit = {
                PackageID: packageid,
                SenderPhone: document.getElementById("SenderNum").value,
                ContactPhone: document.getElementById("RecipientNum").value,
                Weight: document.getElementById("Weight").value,
                Description: document.getElementById("description").value,
                FromAddress: {
                    City: document.getElementById("cityPick").value,
                    Street: document.getElementById("streetPick").value,
                    HouseNum: document.getElementById("houseNumPick").value,
                },
                ToAddress: {
                    City: document.getElementById("cityDrop").value,
                    Street: document.getElementById("streetDrop").value,
                    HouseNum: document.getElementById("houseNumDrop").value,
                },
                Price: document.getElementById("Price").value,
                PickUpDate: document.getElementById("ShippingDate").value,
                DeadLineDate: document.getElementById("Deadlinedate").value
            }

            $.ajax({
                dataType: "json",
                url: "/api/Package/ChangePackageDetails",
                contentType: "application/json",
                type: "PUT",
                data: JSON.stringify(packageToEdit),
                success: function (data) {
                    console.log(data);
                },
                error:
                    function (err) {
                        console.log("in error");
                        console.log(err);
                    }
            });

            setTimeout(BackToMyPackagesPage, 1000);
        }
    </script>
</body>
</html>
